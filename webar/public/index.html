<!doctype html>
<html lang="mn">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR ‚Äî Intro ‚Üí –ú–µ–Ω—é ‚Üí –î–∞—Å–≥–∞–ª</title>

  <!-- iOS/PWA –Ω–∞–π—Ä—Å–∞–≥ –Ω—ç–º—ç–ª—Ç“Ø“Ø–¥ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">
  <meta name="theme-color" content="#000000">

  <!-- –ì–æ–ª stylesheet -->
  <link rel="stylesheet" href="./styles/main.css">

  <!-- ‚úÖ –•—É—É—á–∏–Ω service worker-—É—É–¥—ã–≥ —É–Ω—Ç—Ä–∞–∞–Ω–∞ -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations?.().then(rs => rs.forEach(r => r.unregister()));
    }
  </script>

  <!-- Vendor (CDN) -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js" defer></script>
  <script src="https://unpkg.com/@zappar/zappar-threejs@2.5.2/umd/zappar-threejs.js" defer></script>

  <!-- Vendor –±—ç–ª—ç–Ω –±–æ–ª–º–æ–≥—Ü -->
  <script>
    window.__depsReady = new Promise(res => addEventListener('load', () => {
      res({ THREE: window.THREE, ZapparThree: window.ZapparThree });
    }, { once: true }));
  </script>

  <!-- Permission Overlay CSS (–º–æ–Ω–≥–æ–ª) -->
  <style>
    .perm-overlay {
      position: fixed;
      inset: 0;
      z-index: 99999;
      display: grid;
      place-items: center;
      background: rgba(0, 0, 0, .84);
      backdrop-filter: blur(2px);
    }

    .perm-card {
      width: min(92vw, 560px);
      background: #0b0f14;
      color: #e7eef7;
      border: 1px solid rgba(255, 255, 255, .08);
      border-radius: 16px;
      padding: 28px 24px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, .45);
      text-align: center;
    }

    .perm-title {
      margin: 0 0 10px;
      font-size: 24px;
      font-weight: 800;
    }

    .perm-text {
      margin: 0 0 18px;
      line-height: 1.6;
      color: #c9d6e2;
    }

    .perm-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 6px 0 10px;
    }

    .perm-btn {
      appearance: none;
      border: 1px solid transparent;
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: transform .08s ease, box-shadow .2s ease, background .2s ease;
    }

    .perm-btn.primary {
      background: #2f6bff;
      color: #fff;
      box-shadow: 0 6px 16px rgba(47, 107, 255, .35);
    }

    .perm-btn.primary:active {
      transform: translateY(1px);
    }

    .perm-btn.ghost {
      background: transparent;
      color: #e7eef7;
      border-color: rgba(255, 255, 255, .18);
      border: 1px solid rgba(255, 255, 255, .18);
    }

    .perm-help {
      margin-top: 10px;
      color: #b9c7d6;
      text-align: left;
    }

    .perm-help summary {
      cursor: pointer;
    }

    .perm-help ol {
      margin: 10px 0 0 18px;
    }

    .hidden {
      display: none !important;
    }

    /* üö´ Zappar-–∏–π–Ω built-in permission/compatibility UI-–≥ –Ω—É—É—Ö */
    .zappar-compatibility-ui,
    .zappar-permission-request,
    .zappar-permission-request-ui,
    .zappar-ui,
    .zappar__permission-request,
    .zappar__compatibility {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }

    .backBtn {
      position: fixed;
      /* ‚¨áÔ∏è iOS safe-area: –ó“Æ“Æ–ù –î–≠–≠–î –ë–£–õ–ê–ù */
      top: calc(env(safe-area-inset-top, 0px) + 12px);
      left: calc(env(safe-area-inset-left, 0px) + 12px);
      /* right/bottom —Ö—ç—Ä—ç–≥–≥“Ø–π */
      z-index: 99999;

      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 999px;
      background: rgba(0, 0, 0, .55);
      color: #fff;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      backdrop-filter: blur(6px);
      -webkit-tap-highlight-color: transparent;
    }

    .backBtn:active {
      transform: scale(0.98);
    }

    /* hidden “Ø–µ–¥ –±“Ø—Ä —Ç–∞–≥ –Ω—É—É—Ö (HTML –¥—ç—ç—Ä hidden –∞—à–∏–≥–ª–∞–∂ –±–∞–π–≥–∞–∞) */
    #btnBack[hidden] {
      display: none !important;
    }
  </style>
</head>

<body>
  <!-- ‚úîÔ∏è iOS –¥—ç—ç—Ä—Ö —è–≤—Ü—ã–≥ —Ö–∞—Ä—É—É–ª–∞—Ö —Å—Ç–∞—Ç—É—Å –º”©—Ä -->
  <div id="debugStatus" style="position:fixed;left:16px;top:16px;color:#6cf;font:12px/1.4 monospace;z-index:9999"></div>
  <div id="debug">DEBUG: boot‚Ä¶</div>

  <!-- Tap-to-start -->
  <div id="tapToStart"><button class="btn">‚ñ∂ –≠—Ö–ª“Ø“Ø–ª—ç—Ö (–¥—É—É –Ω—ç—ç—Ö)</button></div>
  <button id="btnUnmute" class="btn">üîä –î—É—É–≥ –∞—Å–∞–∞—Ö</button>
  <!-- Back ‚Üí Menu -->
  <button id="btnBack" class="backBtn" aria-label="Back to menu" hidden>‚Üê</button>


  <!-- Intro buttons -->
  <div id="overlayIntroBtns">
    <div id="ibExercise" class="introbtn">üèÉ –î–ê–°–ì–ê–õ</div>
    <div id="ibGrowth" class="introbtn">üå± –•”®–ì–ñ–ò–õ</div>
    <div id="ibKnowledge" class="introbtn">üìò –•–ò–ß–≠–≠–õ</div>
  </div>

  <!-- –ú–µ–Ω—é -->
  <div id="menu">
    <div class="menu-panel">
      <h2 class="menu-title">AR –ú–µ–Ω—é</h2>
      <p class="menu-sub">–¢—É—Ä—à–ª–∞–≥–∞–∞ —Å–æ–Ω–≥–æ–Ω–æ —É—É</p>
      <div class="menu-grid">
        <div class="card" id="mExercise">
          <div class="icon">üèÉ</div>
          <div>
            <div class="ttl">–î–∞—Å–≥–∞–ª</div>
            <div style="opacity:.8;font-size:12px">–®—É—É–¥ —Ç–æ–≥–ª—É—É–ª–∞—Ö</div>
          </div>
        </div>
        <div class="card" id="mGrowth">
          <div class="icon">üå±</div>
          <div>
            <div class="ttl">–•—É–≤—å —Ö“Ø–Ω–∏–π —Ö”©–≥–∂–∏–ª</div>
            <div style="opacity:.8;font-size:12px">–¢—É–Ω —É–¥–∞—Ö–≥“Ø–π</div>
          </div>
        </div>
        <div class="card" id="mKnowledge">
          <div class="icon">üìò</div>
          <div>
            <div class="ttl">–•–∏—á—ç—ç–ª</div>
            <div style="opacity:.8;font-size:12px">–¢—É–Ω —É–¥–∞—Ö–≥“Ø–π</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- OTP Gate -->
  <div id="otpGate" hidden>
    <div class="otp-panel">
      <h3 class="otp-title">–ë–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞–ª—Ç</h3>
      <p class="otp-sub">–£—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä–∞–∞ –æ—Ä—É—É–ª–∂ 6 –æ—Ä–æ–Ω—Ç–æ–π –∫–æ–¥–æ–æ—Ä –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–Ω–∞ —É—É.</p>
      <div class="otp-field">
        <span>+976</span>
        <input id="otpPhone" type="tel" inputmode="numeric" autocomplete="tel" placeholder="–£—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä (8 —Ü–∏—Ñ—Ä)"
          maxlength="8">
      </div>
      <button id="btnSendCode" class="btn full">–ö–æ–¥ –∞–≤–∞—Ö</button>
      <div id="otpCodeWrap" class="otp-code-wrap" hidden>
        <div class="otp-inputs" id="otpInputs"></div>
        <button id="btnVerifyCode" class="btn full">–ë–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞—Ö</button>
        <div class="otp-meta"><span id="otpTimer">60</span> —Å–µ–∫ –¥–∞—Ä–∞–∞ –¥–∞—Ö–∏–Ω –∏–ª–≥—ç—ç—Ö –±–æ–ª–æ–º–∂—Ç–æ–π.
          <div><button id="btnResend" class="btn ghost" disabled>–î–∞—Ö–∏–Ω –∏–ª–≥—ç—ç—Ö</button></div>
        </div>
      </div>
      <div class="otp-error" id="otpError"></div>
      <div class="devtools"><span class="hint">–¢—É—Ä—à–∏–ª—Ç—ã–Ω –∫–æ–¥: <b>000000</b></span><button id="btnOtpReset"
          class="btn ghost">–î–∞—Ö–∏–Ω —Ç—É—Ä—à–∏—Ö</button></div>
    </div>
  </div>

  <!-- Hidden videos -->
  <video id="vidIntro" playsinline webkit-playsinline autoplay muted preload="auto" crossorigin="anonymous"
    hidden></video>
  <video id="vidExercise" playsinline webkit-playsinline autoplay muted loop preload="auto" crossorigin="anonymous"
    hidden></video>

  <!-- ‚úÖ –ú–æ–Ω–≥–æ–ª Permission Overlay -->
  <div id="permOverlay" class="perm-overlay" aria-modal="true" role="dialog">
    <div class="perm-card">
      <h2 class="perm-title">–ú–∞–Ω–∞–π WEBAR-—Ç —Ç–∞–≤—Ç–∞–π –º–æ—Ä–∏–ª–Ω–æ —É—É?</h2>
      <p class="perm-text">
        –¢–∞ —ç—Ö–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ —Ç”©—Ö”©”©—Ä”©–º–∂–∏–π–Ω—Ö”©”©
        <strong>–∫–∞–º–µ—Ä</strong> –±–æ–ª–æ–Ω <strong>–±–∞–π—Ä—à–ª—ã–Ω</strong> –∑”©–≤—à”©”©—Ä–ª–∏–π–≥ –∑”©–≤—à”©”©—Ä”©—Ö —Ö—ç—Ä—ç–≥—Ç—ç–π.
      </p>
      <div class="perm-actions">
        <button id="btnGrant" class="perm-btn primary">–ó”®–í–®”®”®–†”®–•</button>
        <button id="btnLater" class="perm-btn ghost">–î–∞—Ä–∞–∞ –∞—Å—É—É</button>
      </div>
      <details class="perm-help">
        <summary>iPhone/iPad –¥—ç—ç—Ä –∑”©–≤—à”©”©—Ä”©—Ö –∑–∞–∞–≤–∞—Ä</summary>
        <ol>
          <li>Settings ‚Üí <b>Safari</b> ‚Üí <b>Camera</b> ‚Üí <b>Allow</b> (—ç—Å–≤—ç–ª <b>Ask</b>)</li>
          <li>Settings ‚Üí <b>Safari</b> ‚Üí <b>Location</b> ‚Üí <b>While Using the App</b></li>
          <li>–î–∞—Ä–∞–∞ –Ω—å —Ö—É—É–¥—Å–∞–∞ <b>Refresh</b> —Ö–∏–π–Ω—ç.</li>
        </ol>
      </details>
    </div>
  </div>

  <!-- –¢–∞–Ω–∞–π –º–æ–¥—É–ª–∏—É–¥ -->
  <script type="module" src="./src/app.js"></script>

  <!-- Overlay-–≥ app.js-—Ç—ç–π —Ö–æ–ª–±–æ—Ö -->
  <script type="module">
    const overlay = document.getElementById('permOverlay');
    const grantBtn = document.getElementById('btnGrant');
    const laterBtn = document.getElementById('btnLater');

    async function waitApp() {
      if (window.__appReady && window.ensurePermissionsGate) return;
      await new Promise((res) => {
        const id = setInterval(() => {
          if (window.__appReady && window.ensurePermissionsGate) {
            clearInterval(id); res();
          }
        }, 50);
      });
    }

    grantBtn?.addEventListener('click', async () => {
      overlay?.classList.add('hidden');
      try {
        await waitApp();                         // ‚Üê —ç–Ω–¥—ç—ç—Å –∞–ª–¥–∞–∞ –∑–∞—Å–∞–≥–¥–∞–Ω–∞
        await window.ensurePermissionsGate();    // CAMERA ‚Üí GEO
        await window.ensureCameraOnce();         // Zappar camera
        await window.startIntroFlow(true);       // —É—Ä—Å–≥–∞–ª —ç—Ö–ª“Ø“Ø–ª—ç—Ö
      } catch (e) {
        alert(e?.message || e);
      }
    }, { passive: true });

    laterBtn?.addEventListener('click', () => {
      overlay?.classList.add('hidden');
      // –•—ç—Ä—ç–≥–ª—ç–≥—á –¥–∞—Ä–∞–∞ –∑”©–≤—à”©”©—Ä”©—Ö –±–æ–ª –∑“Ø–≥—ç—ç—Ä –ª —Ö–∞–∞–Ω–∞
    }, { passive: true });
  </script>



</body>

</html>